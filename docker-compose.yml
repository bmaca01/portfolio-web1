# docker-compose.yml
version: '3.8'

services:
  web1-site1:
    build:
      context: ./docker
      dockerfile: Dockerfile.optimized
    container_name: web1-site1-dev
    ports:
      - "8084:8084"  # Match production port (nginx direct)
      - "3000:3000"  # Browser-sync with hot-reload
    volumes:
      # Mount website files for hot-reloading
      - ./website:/var/www/web1-site1:rw
      # Mount vendor directory for Composer dependencies (PHPMailer, etc.)
      - ./vendor:/var/www/vendor:ro
      # Symlink for Composer autoload paths (expects website/ sibling to vendor/)
      - ./website:/var/www/website:ro
      # Persist counter data across container restarts
      - counter_data:/var/lib/web1-site1-counter
      # Optional: Mount logs for debugging (commented out due to permission issues)
      # - ./logs/nginx:/var/log/nginx
      # - ./logs/php:/var/log/php-fpm
    environment:
      - ENVIRONMENT=development
      - TZ=America/New_York
      - ENABLE_HOT_RELOAD=true  # Set to false to disable browser-sync
      # Database credentials (for development only)
      - DB_HOST=mysql
      - DB_NAME=guestbook
      - DB_USER=guestbook_user
      - DB_PASSWORD=guestbook_dev_pass
      - DB_PORT=3306
      # SMTP configuration (optional - email disabled if not set)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-noreply@benjmacaro.dev}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-benjmacaro.dev Contact Form}
      - CONTACT_EMAIL=${CONTACT_EMAIL:-info@benjmacaro.dev}
    restart: no
    networks:
      - web1_network
    depends_on:
      - mysql

  mysql:
    image: mysql:8.0
    container_name: web1-mysql-dev
    environment:
      MYSQL_ROOT_PASSWORD: dev_root_password
      MYSQL_DATABASE: guestbook
      MYSQL_USER: guestbook_user
      MYSQL_PASSWORD: guestbook_dev_pass
    ports:
      - "127.0.0.1:3307:3306"  # Use 3307 to avoid conflict with production
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./database/blog-schema.sql:/docker-entrypoint-initdb.d/02-blog-schema.sql:ro
      - ./database/init-dev.sql:/docker-entrypoint-initdb.d/03-init-dev.sql:ro
    restart: no
    networks:
      - web1_network
    command: --default-authentication-plugin=mysql_native_password

volumes:
  counter_data:
    driver: local
  mysql_data:
    driver: local

networks:
  web1_network:
    driver: bridge